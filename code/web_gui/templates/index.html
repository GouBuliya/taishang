<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qwen 量化助手</title>
    <!-- 替换为 BootCDN 的 Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css">
    <!-- 替换为 BootCDN 的 Marked.js -->
    <script src="https://cdn.bootcdn.net/ajax/libs/marked/12.0.1/marked.min.js"></script>
    <!-- 移除 polyfill.io <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> -->
    
    <!-- MathJax 配置 (不立即加载脚本) -->
    <script id="mathjax-config">
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true
            },
            svg: {
                fontCache: 'global'
            },
            options: {
                enableMenu: false,  // 禁用右键菜单
                processHtmlClass: 'mathjax',  // 只处理带有 mathjax 类的元素
            }
        };
    </script>
    <!-- MathJax 脚本将动态加载 -->
    
    <style>
        :root {
            --primary-color: #3498db;
            --primary-hover: #2980b9;
            --secondary-color: #2ecc71;
            --background-dark: #1a1c1e;
            --background-light: #22272e;
            --text-color: #e0e0e0;
            --text-muted: #a0a0a0;
            --border-color: #2d333b;
            --card-bg: rgba(255, 255, 255, 0.05);
            --success-color: #2ecc71;
            --warning-color: #f1c40f;
            --error-color: #e74c3c;
        }

        body { 
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--background-dark) 0%, #1d2025 100%);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            padding: 2rem;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .main-title {
            font-size: 2.8rem;
            font-weight: 800;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 2rem;
            text-align: center;
            letter-spacing: -1px;
        }

        .card {
            background: var(--background-light);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px rgba(0,0,0,0.3);
        }

        #response-container {
            min-height: 600px;
            max-height: 800px;
            overflow-y: auto;
            padding: 2rem;
            background: var(--background-light);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        }

        #collectAndGeminiBtn {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            border: none;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
            width: 100%;
            max-width: 300px;
        }

        #collectAndGeminiBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        #collectAndGeminiBtn:active {
            transform: translateY(1px);
        }

        #collectAndGeminiBtn:disabled {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
            cursor: not-allowed;
        }

        #gemini_status_message {
            color: var(--text-muted);
            font-size: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 12px;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        #screenshot-preview {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        #preview-image {
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            max-width: 100%;
            height: auto;
        }

        #preview-image:hover {
            transform: scale(1.02);
        }

        #gemini_content_area {
            font-size: 1.1rem;
            line-height: 1.8;
            color: var(--text-color);
        }

        #gemini_content_area h1,
        #gemini_content_area h2,
        #gemini_content_area h3 {
            color: var(--primary-color);
            margin-top: 1.5em;
            margin-bottom: 0.8em;
            font-weight: 600;
        }

        #gemini_content_area code {
            background: rgba(0,0,0,0.3);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            color: #e83e8c;
            font-family: 'JetBrains Mono', monospace;
        }

        #gemini_content_area pre {
            background: rgba(0,0,0,0.3);
            padding: 1.5rem;
            border-radius: 12px;
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }

        #gemini_content_area blockquote {
            border-left: 4px solid var(--primary-color);
            padding: 1rem 1.5rem;
            margin: 1.5rem 0;
            background: var(--card-bg);
            border-radius: 0 12px 12px 0;
        }

        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-dark);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }

        .loading {
            animation: pulse 2s infinite;
        }

        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .main-title { font-size: 2rem; }
            .card { padding: 1rem; }
            #response-container { 
                min-height: 400px;
                padding: 1rem;
            }
            #collectAndGeminiBtn {
                font-size: 1rem;
                padding: 0.8rem 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="main-title">Qwen 金融智能体</h1>
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card">
                    <div class="d-flex flex-column align-items-center">
                        <button id="collectAndGeminiBtn" class="btn btn-primary mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lightning-charge-fill me-2" viewBox="0 0 16 16">
                                <path d="M11.251.068a.5.5 0 0 1 .227.58L9.677 6.5H13a.5.5 0 0 1 .364.843l-8 8.5a.5.5 0 0 1-.842-.49L6.323 9.5H3a.5.5 0 0 1-.364-.843l8-8.5a.5.5 0 0 1 .615-.09z"/>
                            </svg>
                            一键采集并推理
                        </button>
                        <div id="gemini_status_message" class="w-100 text-center">
                            准备就绪，请点击按钮开始分析...
                        </div>
                    </div>
                </div>
                <div id="screenshot-preview" class="card d-none">
                    <h5 class="text-light mb-3">最新截图预览</h5>
                    <img id="preview-image" class="img-fluid" alt="Trading View 截图">
                    <p id="screenshot-time" class="text-muted mt-2 mb-0 text-center"></p>
                </div>
            </div>
            <div class="col-lg-8">
                <div id="response-container">
                    <div id="gemini_content_area"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
    let mathJaxLoaded = false; // 标记 MathJax 是否已加载

    const statusP = document.getElementById('gemini_status_message');
    const contentDiv = document.getElementById('gemini_content_area');
    const btn = document.getElementById('collectAndGeminiBtn');
    const screenshotPreview = document.getElementById('screenshot-preview');
    const previewImage = document.getElementById('preview-image');
    const screenshotTime = document.getElementById('screenshot-time');
    
    // 异步加载 MathJax 脚本的函数
    async function loadMathJax() {
        if (!mathJaxLoaded) {
            const script = document.createElement('script');
            script.src = "https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"; // 保持使用jsdelivr的MathJax
            script.async = true; // 异步加载
            document.head.appendChild(script);
            await new Promise(resolve => script.onload = resolve); // 等待加载完成
            mathJaxLoaded = true;
            console.log('MathJax 脚本已动态加载');
        }
    }

    btn.addEventListener('click', async () => {
        statusP.textContent = '正在采集数据并推理，请稍候...';
        statusP.style.color = 'inherit';
        contentDiv.innerHTML = '';
        btn.disabled = true;
        try {
            const response = await fetch('/api/qwen_advice', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            
            // 检查data.json中的screenshot_path并更新预览
            const dataResponse = await fetch('/data.json');
            if (dataResponse.ok) {
                const data = await dataResponse.json();
                if (data.clipboard_image_path) {
                    // 获取当前时间戳作为参数，防止浏览器缓存图片
                    const imgTimestamp = new Date().getTime();
                    previewImage.src = `/cache_screenshots/${data.clipboard_image_path.split('/').pop()}?t=${imgTimestamp}`;
                    screenshotTime.textContent = `截图时间：${new Date().toLocaleString('zh-CN')}`;
                    screenshotPreview.classList.remove('d-none');
                }
            }
            
            if (!response.ok || !response.body) {
                let errorMsg = `错误: ${response.status} ${response.statusText}`;
                try {
                    const errorJson = await response.json();
                    errorMsg = `错误: ${errorJson.error || '无法启动建议流。'}`;
                } catch (e) {}
                statusP.textContent = errorMsg;
                statusP.style.color = 'red';
                btn.disabled = false;
                return;
            }
            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            let buffer = '';
            let markdownBuffer = '';
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                let lines = buffer.split('\n');
                buffer = lines.pop();
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const eventData = JSON.parse(line.substring(5).trim());
                            if (eventData.type === 'status') {
                                statusP.textContent = `状态: ${eventData.message || eventData.stage}`;
                                statusP.style.color = 'inherit';
                            } else if (eventData.type === 'content') {
                                markdownBuffer += eventData.text;
                                contentDiv.innerHTML = marked.parse(markdownBuffer);
                                contentDiv.classList.add('mathjax'); // 添加类
                                
                                // 只有当 MathJax 脚本加载完成后才尝试渲染
                                // 这里使用异步加载 MathJax
                                if (!mathJaxLoaded && markdownBuffer.includes('$$') || markdownBuffer.includes('$')) { // 仅当检测到公式时才加载
                                    await loadMathJax();
                                }
                                if (window.MathJax && MathJax.typesetPromise) { // 确保加载完成后再渲染
                                    MathJax.typesetPromise([contentDiv]).catch(function (err) {
                                        console.log('MathJax 渲染错误:', err);
                                    });
                                }
                                
                                // 自动滚动到底部
                                contentDiv.scrollTop = contentDiv.scrollHeight;
                            } else if (eventData.type === 'error') {
                                statusP.textContent = `错误: ${eventData.message}`;
                                statusP.style.color = 'red';
                                reader.cancel();
                                break;
                            }
                        } catch (e) {
                            statusP.textContent = `数据解析错误: ${e.message}`;
                            statusP.style.color = 'red';
                        }
                    }
                }
            }
        } catch (error) {
            statusP.textContent = `连接错误或获取建议失败: ${error.message}`;
            statusP.style.color = 'red';
        } finally {
            btn.disabled = false;
        }
    });
    </script>
</body>
</html>