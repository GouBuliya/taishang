# `app.py` 代码框架

## 导入模块

## 全局配置与初始化

## 辅助函数

- `extract_all_text(data)`: 递归提取文本
- `send_ai_reply_email(subject, content, to_addrs)`: 发送邮件
- `coin_task(...)`: 执行单个币种任务流程 (数据采集 -> Gemini 推理 -> 邮件发送)。**计划增强**: 在 ETH 流程成功完成后，额外运行 `trade_api_eth.py` 脚本。
- `schedule_gemini_task()`: 定时任务逻辑
- `clean_memory_on_start()`: 清理内存和缓存

## `/root/codespace/Qwen_quant_v1/trade_bot/trade_api_eth.py` 代码分析

- **导入模块和配置**: 导入 OKX API, json, os, logging 等。加载 `config.json` 和 `gemini_answer.json`。
- **API 初始化**: 初始化 OKX 的 TradeAPI 和 AccountAPI，使用配置文件中的密钥和交易模式。
- **`place_order_with_three_tp(...)` 函数**: 用于下单（市价或限价），并附加止损 (SL) 和一级止盈 (TP) 的算法单。目前只实现了一级止盈 (9:1 的比例)。
- **`close_position(...)` 函数**: 用于平仓。根据当前持仓方向（多或空）执行市价平仓。还包含取消或修改现有挂单的逻辑。
- **`trade_api(execution)` 函数**: 根据 `execution` 字典的 `type` 字段调用不同的交易操作：
    - `"buy"` 或 `"sell"`: 调用 `place_order_with_three_tp` 进行下单。
    - `"wait"`: 记录日志，不执行操作。
    - `"close"`: 调用 `close_position` 进行平仓（TODO 标记）。
    - 其他: 记录警告。
- **主执行块 (`if __name__ == "__main__":`)**:
    - 设置仓位模式为 `net_mode`。
    - 设置 ETH-USDT-SWAP 合约在 `cross` 模式下的杠杆。
    - 调用 `trade_api(execution)` 执行交易逻辑。

**总结**: `trade_api_eth.py` 是一个基于 OKX API 的交易执行脚本，它读取 Gemini 的分析结果 (`gemini_answer.json`)，并根据其中的指令执行下单或平仓操作。已实现了基本的下单和部分平仓逻辑，但止盈部分目前只实现了一级，且平仓逻辑标记为 TODO。**计划增强**: 在脚本运行结束时，将本次交易操作的关键结果追加到 `trade_log.json` 文件中。

## Flask 路由

- `/` (`index()`